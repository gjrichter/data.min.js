!function(window,document,undefined){function expose(){var e=window.Data;Data.noConflict=function(){return window.Data=e,this},window.Data=Data}var _log_start_time=new Date;_LOG=function(e){new Date;var t=(new Date-_log_start_time)/1e3;console.log("_LOG: time[sec.ms] "+t+" "+e)},__isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)},__toArray=function(e){return e&&void 0!==e?__isArray(e)?e:String(e).match(/\|/)?String(e).split("|"):String(e).split(","):[]},__onlyUnique=function(e,t,i){return i.indexOf(e)===t};var Data={version:"1.46",errors:[]};"object"==typeof module&&"object"==typeof module.exports?module.exports=Data:"function"==typeof define&&define.amd&&define(Data),void 0!==window&&expose(),Data.Object=function(e){this.options=e,this.debug=!1},Data.Object.prototype={import:function(e){return this.options.success=e,this.feed=Data.feed({}),this.feed.options=this.options,"csv"==this.options.type||"CSV"==this.options.type?this.feed.__processCSVData(this.options.source,this.options):"rss"==this.options.type||"RSS"==this.options.type?this.feed.__processRSSData(this.options.source,this.options):"kml"==this.options.type||"KML"==this.options.type?this.feed.__processKMLData(this.options.source,this.options):"json"==this.options.type||"JSON"==this.options.type||"Json"==this.options.type?this.feed.__processJsonData(this.options.source,this.options):"geojson"==this.options.type||"GEOJSON"==this.options.type||"GeoJson"==this.options.type?this.feed.__processGeoJsonData(this.options.source,this.options):"topojson"!=this.options.type&&"TOPOJSON"!=this.options.type&&"TopoJson"!=this.options.type||this.feed.__processTopoJsonData(this.options.source,this.options),this},error:function(e){return this.options.error=e,this}},Data.Import=function(e){this.options=e,this.debug=!1},Data.Feed=function(e){this.options=e||{},this.debug=!1,this.options.error=function(e){Data.errors.push(e)}},Data.Feed.prototype={load:function(e){this.options.success=e;var t=this.options,i=t.source||t.src||t.url||t.ext,s=this;return i||_alert("Data.feed(...).load(): no source defined !",2e3),"csv"==t.type||"CSV"==t.type?this.__doCSVImport(i,t):"rss"==t.type||"RSS"==t.type?this.__doRSSImport(i,t):"kml"==t.type||"KML"==t.type?this.__doKMLImport(i,t):"json"==t.type||"JSON"==t.type||"Json"==t.type?this.__doJSONImport(i,t):"geojson"==t.type||"GEOJSON"==t.type||"GeoJson"==t.type?this.__doGeoJSONImport(i,t):"topojson"==t.type||"TOPOJSON"==t.type||"TopoJson"==t.type?this.__doTopoJSONImport(i,t):"jsonDB"==t.type||"JSONDB"==t.type||"JsonDB"==t.type||"jsondb"==t.type?this.__doJsonDBImport(i,t):"jsonstat"==t.type||"jsonStat"==t.type||"JSONSTAT"==t.type?$.getScript("http://json-stat.org/lib/json-stat.js").done(function(e,o){s.__doLoadJSONstat(i,t)}).fail(function(e,i,s){_alert("'"+t.type+"' unknown format !")}):_alert("'"+t.type+"' unknown format !"),this},error:function(e){return this.options.error=e,this}},Data.feed=function(e){return new Data.Feed(e)},Data.object=function(e){return new Data.Object(e)},Data.import=function(e){return new Data.Object(e).import().feed.dbtable};var ixmaps=ixmaps||{};Data.Feed.prototype.__doLoadJSONstat=function(e,t){var i=this;JSONstat(e,function(){var e=new Array,s=[this.Dataset(0).Dimension(0).label],o=this.Dataset(0).Dimension(1).id;for(r=0;r<o.length;r++)s.push(this.Dataset(0).Dimension(1).Category(o[r]).label);e.push(s);for(var r=0;r<this.Dataset(0).Dimension(0).length;r++){(s=new Array).push(this.Dataset(0).Dimension(0).Category(this.Dataset(0).Dimension(0).id[r]).label);for(var a=0;a<this.Dataset(0).Dimension(1).length;a++)s.push(this.Dataset(0).Data([r,a]).value);e.push(s)}t.callback?t.callback(e,t):i.__createDataTableObject(e,t.type,t)})},Data.Feed.prototype.__doJsonDBImport=function(e,t){_LOG("__doJsonDBImport: "+e);var i=this;t.url=e,$.getScript(e+".gz").done(function(e,s){i.__processJsonDBData(e,t)}).fail(function(s,o,r){$.getScript(e).done(function(e,s){i.__processJsonDBData(e,t)}).fail(function(t,s,o){i.options.error&&i.options.error('"'+e+'" '+o)})})},Data.Feed.prototype.__processJsonDBData=function(script,opt){_LOG("__processJsonDBData:"),this.dbtable=new Data.Table;var name=opt.source.split(/\//).pop();name=name.split(/\./)[0];var loadedTable=eval(name);this.dbtable.table=loadedTable.table,this.dbtable.fields=loadedTable.fields,this.dbtable.records=loadedTable.records,opt.callback?opt.callback(newData,opt):void 0!==opt&&opt.success&&opt.success(this.dbtable)},Data.Feed.prototype.__doCSVImport=function(e,t){_LOG("__doCSVImport: "+e);var i=this;$.ajax({type:"GET",url:e,dataType:"text",success:function(e){i.__processCSVData(e,t)},error:function(i,s,o){void 0!==t&&t.error&&t.error('"'+e+'" '+o)}})},Data.Feed.prototype.__processCSVData=function(e,t){_LOG("__processCSVData:"+t.source+(t.options?" -> "+t.options.name:""));new Array(0),new Array(0);if("undefined"==typeof Papa)return _LOG("__processCSVData:load csv parser!"),__this=this,void $.getScript("https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.2/papaparse.min.js").done(function(i,s){__this.__processCSVData(e,t)}).fail(function(e,i,s){_alert("'"+t.type+"' parser not loaded !")});var i=Papa.parse(e,t.parser).data;return _LOG("csv parser: done "+t.source+(t.options?" -> "+t.options.name:"")),void 0===i[0]||void 0===i[1]?(_alert(i),t.error&&t.error(i),!1):(t.parser&&t.parser.delimiter||i[0].length!=i[1].length&&(_LOG("csv parser: autodetect failed"),_LOG("csv parser: delimiter = ;"),(i=Papa.parse(e,{delimiter:";"}).data)[0].length!=i[1].length&&(_LOG("csv parser: delimiter = ; failed"),_LOG("csv parser: delimiter = ,"),(i=Papa.parse(e,{delimiter:","}).data)[0].length!=i[1].length&&(_LOG("csv parser: delimiter = , failed"),_alert("csv parsing error")))),i[i.length-1].length!=i[0].length&&i.pop(),i[0].length-i[1].length==1&&" "==i[0][i[0].length-1]&&i[0].pop(),t.callback?void t.callback(i,t):(_LOG("__createDataTableObject: "+(t.options?" -> "+t.options.name:"")),this.__createDataTableObject(i,t.type,t),e=null,i=null,!1))},Data.Feed.prototype.__doRSSImport=function(e,t){_LOG("__doRSSImport: "+e);var i=this;t.format="xml",$.ajax({type:"GET",url:e,dataType:"xml",success:function(e){i.__processRSSData(e,t)},error:function(e,i,s){void 0!==t&&t.error&&t.error(e,i,s)}})},Data.Feed.prototype.__processRSSData=function(e,t){if("xml"==t.format){$(e).find("rss").length?this.__parseRSSData(e,t):$(e).find("feed").length?_alert("feed not yet supported"):$(e).find("atom").length&&_alert("atom not yet supported")}},Data.Feed.prototype.__parseRSSData=function(e,t){var i=this;if("xml"==t.format){$(e).find("rss").attr("version");$(e).find("channel").each(function(){var s=[],o=null;$(e).find("item").each(function(){if(!o){var e=[];o=[];for(var t=$(this).children(),i=0;i<t.length;i++){for(var r=$(this).children()[i].nodeName;e[r];)r+="*";e[r]=r,o[i]=r}s.push(o)}var a=[];for(i=0;i<o.length;i++)"enclosure"==o[i]?a.push($(this).find(o[i]+":first").attr("url")||""):a.push($(this).find(o[i]+":first").text()||"");s.push(a)}),i.__createDataTableObject(s,"rss",t)})}},Data.Feed.prototype.__doKMLImport=function(e,t){_LOG("__doKMLImport: "+e);var i=this;t.format="xml",$.ajax({type:"GET",url:e,dataType:"xml",success:function(e){i.__processKMLData(e,t)},error:function(e,i,s){void 0!==t&&t.error&&t.error(e,i,s)}})},Data.Feed.prototype.__processKMLData=function(e,t){if("xml"==t.format){$(e).find("kml").length?this.__parseKMLData(e,t):_alert("feed not kml")}},Data.Feed.prototype.__parseKMLData=function(e,t){if("xml"==t.format){$(e).find("kml").attr("xmlns");var i=[],s=null;$(e).find("Document").find("Placemark").each(function(){var e=$(this).find("ExtendedData")||$(this);s||(s=[],e.find("Data").each(function(){s.push($(this).attr("name"))}),$(this).find("Point").find("coordinates")&&s.push("KML.Point"),i.push(s));var t=[];e.find("Data").each(function(){t.push($(this).find("value").text())}),$(this).find("Point").find("coordinates")&&t.push($(this).find("Point").find("coordinates").text()),i.push(t)}),this.__createDataTableObject(i,"kml",t)}},Data.Feed.prototype.__doJSONImport=function(e,t){var i=this;$.get(e,function(e){i.__processJsonData(e,t)}).fail(function(e){void 0!==t&&t.error&&t.error(e)})},Data.Feed.prototype.__processJsonData=function(e,t){if("string"==typeof e)try{var i=JSON.parse(e)}catch(e){this.__createDataTableObject([],"json",t)}else i=e;this.data=i;var s=[],o=[];if(i&&i.data&&i.data.columns&&i.data.rows){var r=i.data.columns,a=i.data.rows;for(var n in r)o.push(r[n]);s.push(o);for(n=0;n<a.length;n++){o=[];for(var l in a[0])o.push(a[n][l]);s.push(o)}}else{i&&i.data&&(i=i.data);for(var u in i[0])if("object"==typeof i[0][u]&&null!=i[0][u])for(var h in i[0][u])if("object"==typeof i[0][u][h])for(var c in i[0][u][h])o.push(u+"."+h+"."+c);else o.push(u+"."+h);else o.push(u);s.push(o);for(n=0;n<i.length;n++){o=[];for(var u in i[0])if("object"==typeof i[n][u])for(var h in i[n][u])if("object"==typeof i[n][u][h])for(var c in i[n][u])o.push(i[n][u][h][c]);else o.push(i[n][u][h]);else o.push(i[n][u]);s.push(o)}}this.__createDataTableObject(s,"json",t)},Data.Feed.prototype.__doGeoJSONImport=function(e,t){var i=this;$.get(e,function(e){i.__processGeoJsonData(e,t)}).fail(function(e){void 0!==t&&t.error&&t.error(e)})},Data.Feed.prototype.__processGeoJsonData=function(e,t){if("string"==typeof e)try{var i=JSON.parse(e)}catch(e){this.__createDataTableObject([],"json",t)}else i=e;this.data=i;var s=[],o=[],r=[];if(i&&i.features&&i.features.length){for(a=0;a<i.features.length;a++)for(p in i.features[a].properties)r[p]=!0;for(p in r)o.push(p);o.push("geometry"),s.push(o);for(var a=0;a<i.features.length;a++){for(o=[],p=0;p<s[0].length-1;p++)"object"==typeof i.features[a].properties[s[0][p]]?o.push(JSON.stringify(i.features[a].properties[s[0][p]]||"")):o.push(i.features[a].properties[s[0][p]]||"");o.push(JSON.stringify(i.features[a].geometry)),s.push(o)}}this.__createDataTableObject(s,"json",t)},Data.Feed.prototype.__processGeoJsonData_expandProperty=function(e,t){if("string"==typeof e)try{var i=JSON.parse(e)}catch(e){this.__createDataTableObject([],"json",t)}else i=e;this.data=i;var s=[],o=[],r=[];if(i&&i.features&&i.features.length){for(a=0;a<i.features.length;a++)for(p in i.features[a].properties)if("string"==typeof i.features[a].properties[p]||"number"==typeof i.features[a].properties[p])r[p]=!0;else for(pp in i.features[a].properties[p])r[p+"."+pp]=!0;for(p in r)o.push(p);o.push("geometry"),s.push(o);for(var a=0;a<i.features.length;a++){for(o=[],p=0;p<s[0].length-1;p++){var n=s[0][p].split(".");n.length>=2?o.push(i.features[a].properties[n[0]][n[1]]||""):o.push(i.features[a].properties[s[0][p]]||"")}o.push(JSON.stringify(i.features[a].geometry)),s.push(o)}}this.__createDataTableObject(s,"json",t)},Data.Feed.prototype.__doTopoJSONImport=function(e,t){var i=this;$.get(e,function(e){i.__processTopoJsonData(e,t)}).fail(function(e){void 0!==t&&t.error&&t.error(e)})},Data.Feed.prototype.__processTopoJsonData=function(e,t){if("undefined"!=typeof topojson){if("string"==typeof e)try{var i=JSON.parse(e)}catch(e){this.__createDataTableObject([],"json",t)}else i=e;this.data=i;var s=null;if(t.options&&t.options.name&&i.objects[t.options.name])s=topojson.feature(i,i.objects[t.options.name]);else for(o in i.objects){s=topojson.feature(i,i.objects[o]);break}for(var o in s.features)s.features[o].properties.id=s.features[o].id;this.__processGeoJsonData(s,t)}else _alert("'"+t.type+"' parser not loaded !")},Data.Feed.prototype.__createDataTableObject=function(e,t,i){if(e)return this.dbtable=(new Data.Table).setArray(e),e=null,void(void 0!==i&&i.success&&i.success(this.dbtable))},Data.Table=function(e){e?(this.table=e.table,this.fields=e.fields,this.records=e.records):(this.table={records:0,fields:0},this.fields=[],this.records=[])},Data.Table.prototype={getArray:function(){var e=[[]];for(var t in this.fields)e[0].push(this.fields[t].id);for(t=0;t<this.records.length;t++)e.push(this.records[t]);return e},setArray:function(e){this.fields=[];for(var t in e[0])this.fields.push({id:(e[0][t]||" ").trim(),typ:0,width:60,decimals:0});e.shift(),this.records=[];for(var i in e)e[i].length==this.fields.length&&this.records.push(e[i]);return this.table={records:this.records.length,fields:this.fields.length},this},revert:function(){for(var e=[],t=this.records.length-1;t>=0;t--)e.push(this.records[t]);return this.records=e,this},reverse:function(){for(var e=[],t=this.records.length-1;t>=0;t--)e.push(this.records[t]);return this.records=e,this},columnNames:function(){var e=[];for(var t in this.fields)e.push(this.fields[t].id);return e},columnIndex:function(e){for(var t in this.fields)if(this.fields[t].id==e)return t;return null},column:function(e){for(var t in this.fields)if(this.fields[t].id==e){var i=new Data.Column;return i.index=t,i.table=this,i}return null},lookupArray:function(e,t){var s="overwrite";e&&e.key&&(s=e.calc||s,t=e.key,e=e.value);var o=[];this.column(t)||alert("'"+t+"' column not found!"),this.column(e)||alert("'"+e+"' column not found!");var r=this.column(t).values(),a=this.column(e).values();if("sum"==s)for(i in r)o[String(r[i])]=(o[String(r[i])]||0)+a[i];else if("max"==s)for(i in r)o[String(r[i])]=Math.max(o[String(r[i])]||0,a[i]);else for(i in r)o[String(r[i])]=a[i];return o},lookupStringArray:function(e,t){e&&e.key&&(t=e.key,e=e.value);var s=[];this.column(t)||alert("'"+t+"' column not found!"),this.column(e)||alert("'"+e+"' column not found!");var o=this.column(t).values(),r=this.column(e).values();for(i in o)r[i]&&(s[String(o[i])]=s[String(o[i])]?s[String(o[i])]+", "+r[i]:r[i]);return s},lookup:function(e,t){var i=t.value,s=t.lookup,o=i+"_"+s;return this.lookupsA&&this.lookupsA[o]||(this.lookupsA=this.lookupsA||[],this.lookupsA[o]=this.lookupArray(i,s)),this.lookupsA[o][e]||"-"},addColumn:function(e,t){if(!e.destination)return alert("'data.addColumn' no destination defined!"),null;var i=null;if(e.source){for(var s in this.fields)this.fields[s].id==e.source&&(i=s);if(null==i)return alert("'data.addColumn' source column '"+e.source+"' not found!"),null}if(this.fields.push({id:String(e.destination),created:!0}),this.table.fields++,t&&"function"==typeof t)for(var o in this.records)this.records[o].push(t(null!=i?this.records[o][i]:this.records[o]));else if(t&&"object"==typeof t)for(var o in this.records)this.records[o].push(t[o]||0);else if(e.values&&"object"==typeof e.values)for(var o in this.records)this.records[o].push(e.values[o]||0);else for(var o in this.records)this.records[o].push(0);return this},addRow:function(e){if(!e||"object"!=typeof e)return alert("'data.addRow' no options defined!"),null;var t=[];for(var i in this.fields)t.push(" ");for(var i in e)this.column(i)?t[this.column(i).index]=e[i]:alert("'data.addRow' column '"+i+"' not found!");return this.records.push(t),this.table.records++,this},filter:function(e){this.selection=new Data.Table;for(var t in this.records)e&&e(this.records[t])&&(this.selection.records.push(this.records[t]),this.selection.table.records++);return this.selection.fields=this.fields.slice(),this.selection.table.fields=this.table.fields,this.selection},select:function(szSelection){if(szSelection.match(/WHERE/)){for(var szTokenA=szSelection.split("WHERE")[1].trim().split(" "),ii=0;ii<szTokenA.length;ii++)if(szTokenA[ii].length){if('"'==szTokenA[ii][0]&&'"'!=szTokenA[ii][szTokenA[ii].length-1])do{szTokenA[ii]=szTokenA[ii]+" "+szTokenA[ii+1],szTokenA.splice(ii+1,1)}while('"'!=szTokenA[ii][szTokenA[ii].length-1]);if("("==szTokenA[ii][0]&&")"!=szTokenA[ii][szTokenA[ii].length-1])do{szTokenA[ii]=szTokenA[ii]+" "+szTokenA[ii+1],szTokenA.splice(ii+1,1)}while(")"!=szTokenA[ii][szTokenA[ii].length-1])}else szTokenA.splice(ii,1),ii--;this.filterQueryA=[];var filterObj={},szCombineOp="";do{var nToken=0;if(szTokenA.length>=3&&(filterObj={},filterObj.szSelectionField=szTokenA[0].replace(/("|)/g,""),filterObj.szSelectionOp=szTokenA[1],filterObj.szSelectionValue=szTokenA[2].replace(/("|)/g,""),nToken=3),"BETWEEN"==filterObj.szSelectionOp&&szTokenA.length>=5&&"AND"==szTokenA[3]&&(filterObj.szSelectionValue2=szTokenA[4],nToken=5),!nToken){_alert("data.js - selection error - incomplete query!\nquery: "+szSelection);break}for(var ii=0;ii<this.fields.length;ii++)this.fields[ii].id==filterObj.szSelectionField&&(filterObj.nFilterFieldIndex=ii),"$"+this.fields[ii].id+"$"==filterObj.szSelectionValue&&(filterObj.nFilterValueIndex=ii);if(filterObj.szCombineOp=szCombineOp,this.filterQueryA.push(filterObj),szTokenA.splice(0,nToken),szTokenA.length&&"AND"==szTokenA[0])szCombineOp="AND",szTokenA.splice(0,1);else{if(!szTokenA.length||"OR"!=szTokenA[0])break;szCombineOp="OR",szTokenA.splice(0,1)}}while(szTokenA.length);this.selection=new Data.Table;for(var i in this.filterQueryA)if(void 0===this.filterQueryA[i].nFilterFieldIndex)return this.selection.fields=this.fields.slice(),this.selection.table.fields=this.table.fields,_LOG("Selection: invalid query: "+szSelection),this.selection;for(var j in this.records){var allResult=null;for(var i in this.filterQueryA){var result=!0;this.__szValue=String(this.records[j][this.filterQueryA[i].nFilterFieldIndex]),this.__szSelectionOp=this.filterQueryA[i].szSelectionOp.toUpperCase(),this.__szSelectionValue=this.filterQueryA[i].szSelectionValue,this.__szSelectionValue2=this.filterQueryA[i].szSelectionValue2,this.__szCombineOp=this.filterQueryA[i].szCombineOp,null!=this.filterQueryA[i].nFilterValueIndex&&(this.__szSelectionValue=String(this.records[j][this.filterQueryA[i].nFilterValueIndex]));var nValue=__scanValue(this.__szValue);result="="==this.__szSelectionOp?"*"==this.__szSelectionValue?""!=this.__szValue.replace(/ /g,""):this.__szValue==this.__szSelectionValue||nValue==Number(this.__szSelectionValue):"<>"==this.__szSelectionOp?!(this.__szValue==this.__szSelectionValue||nValue==Number(this.__szSelectionValue)):">"==this.__szSelectionOp?nValue>Number(this.__szSelectionValue):"<"==this.__szSelectionOp?nValue<Number(this.__szSelectionValue):">="==this.__szSelectionOp?nValue>=Number(this.__szSelectionValue):"<="==this.__szSelectionOp?nValue<=Number(this.__szSelectionValue):"LIKE"==this.__szSelectionOp?"*"==this.__szSelectionValue?this.__szValue.length:eval("this.__szValue.match(/"+this.__szSelectionValue.replace(/\//gi,"\\/")+"/i)"):"NOT"==this.__szSelectionOp?!eval("this.__szValue.match(/"+this.__szSelectionValue.replace(/\//gi,"\\/")+"/i)"):"IN"==this.__szSelectionOp?eval("this.__szSelectionValue.match(/\\("+this.__szValue+"\\,/)")||eval("this.__szSelectionValue.match(/\\,"+this.__szValue+"\\,/)")||eval("this.__szSelectionValue.match(/\\,"+this.__szValue+"\\)/)"):"BETWEEN"==this.__szSelectionOp?nValue>=Number(this.__szSelectionValue)&&nValue<=Number(this.__szSelectionValue2):eval("this.__szValue.match(/"+this.__szSelectionValue.replace(/\//gi,"\\/")+"/i)"),allResult="AND"==this.__szCombineOp?allResult&&result:allResult||result}allResult&&(this.selection.records.push(this.records[j]),this.selection.table.records++)}}return this.selection.fields=this.fields.slice(),this.selection.table.fields=this.table.fields,this.selection},aggregate:function(e,t){var i=!1;e.lead&&(i=e.calc&&"mean"==e.calc,t=e.lead,e=e.column||e.value);for(var s=t.split("|"),o=[],r=null,a=0;a<s.length;a++)for(var n=0;n<this.fields.length;n++)this.fields[n].id==s[a]&&(o[a]=n),this.fields[n].id==e&&(r=n);this.aggregation=new Data.Table,xRecords=[],xCount=[];for(var l in this.records){xField="";for(a=0;a<o.length;a++)xField+=this.records[l][o[a]];if(xRecords[xField])xRecords[xField][o.length]+=__scanValue(this.records[l][r]),xCount[xField][o.length]++;else{xRecords[xField]=[],xRecords[xField][o.length]=__scanValue(this.records[l][r]);for(a=0;a<o.length;a++)xRecords[xField][a]=this.records[l][o[a]];xCount[xField]=[],xCount[xField][o.length]=1}}for(var l in xRecords)i&&(xRecords[l][o.length]/=xCount[l][o.length]),this.aggregation.records.push(xRecords[l]),this.aggregation.table.records++;var u=[];for(a=0;a<s.length;a++)u[a]={id:s[a]};return u[s.length]={id:e},this.aggregation.fields=u,this.aggregation.table.fields=u,this.aggregation},condense:function(e,t){var s={},o=[];e&&e.lead&&(e=(t=e).lead);var r=this.columnIndex(e);if(t&&t.keep)if("string"==typeof t.keep)o[this.columnIndex(t.keep)]=!0;else for(i=0;i<t.keep.length;i++)o[this.columnIndex(t.keep[i])]=!0;for(var a=[],n=0;n<this.records.length;n++){var l=String(this.records[n][r]);if(null!=s[l]){var u=s[l];for(v in this.records[n])if(!o[v])if(isNaN(this.records[n][v])){if(isNaN(this.records[n][v])&&a[u][v]!=this.records[n][v]){var h=parseFloat(String(a[u][v]).split(" (+")[1])||0;a[u][v]=String(a[u][v]).split(" (+")[0]+" (+"+ ++h+") "}}else t&&"max"==t.calc?a[u][v]=Math.max(Number(a[u][v]),Number(this.records[n][v])):a[u][v]=Number(a[u][v])+Number(this.records[n][v])}else a.push(this.records[n].slice()),s[l]=a.length-1}return this.records=a.slice(),this},groupColumns:function(e){var t=e.source,s=[];for(i in t)s[i]=this.column(t[i]).index;return this.addColumn({destination:e.destination},function(e){var t=0;for(i in s)t+=Number(e[s[i]]);return t}),this},pivot:function(e){e.lead=e.lead||e.rows,e.cols=e.cols||e.columns,e.keep=e.keep||[],e.sum=e.sum||[],e.lead=__toArray(e.lead),e.cols=__toArray(e.cols),e.keep=__toArray(e.keep),e.sum=__toArray(e.sum),e.value=__toArray(e.value),e.forced=__toArray(e.forced);for(var t=[],i=0;i<this.fields.length;i++)t[String(this.fields[i].id)]=i;for(i in e.lead)void 0===t[e.lead[i]]&&_alert("data.pivot - pivot keep column '"+e.lead[i]+"' not found");for(i in e.cols)e.cols&&void 0===t[e.cols[i]]&&_alert("data.pivot - pivot columns source column '"+e.cols[i]+"' not found");for(i in e.keep)void 0===t[e.keep[i]]&&_alert("data.pivot - pivot keep column '"+e.keep[i]+"' not found");for(i in e.sum)void 0===t[e.sum[i]]&&_alert("data.pivot - pivot sum column '"+e.sum[i]+"' not found");for(i in e.value)void 0===t[e.value[i]]&&_alert("data.pivot - pivot value column '"+e.value[i]+"' not found");var s=[],o=[],r=this.records;if(e.forced)for(i in e.forced)console.log(e.forced[i]),o[String(e.forced[i])]=0;for(var a=0;a<r.length;a++){for(var n=String(r[a][t[e.lead[0]]]),l=1;l<e.lead.length;l++)n+="|"+r[a][t[e.lead[l]]];var u=String(r[a][t[e.cols[0]]]);if("string"==e.calc)var h=r[a][t[e.value[0]]];else{h=1;if(e.value&&e.value.length){h=0;for(l=0;l<e.value.length;l++)h+=e.value[l]?__scanValue(r[a][t[e.value[l]]]):1}}if((!u||u.length<1)&&(u="undefined"),void 0===o[u]&&(o[u]=0),s[n]){for(l=0;l<e.keep.length;l++)r[a][t[e.keep[l]]].length&&s[n][e.keep[l]]!=r[a][t[e.keep[l]]]&&(s[n][e.keep[l]]=r[a][t[e.keep[l]]]);for(l=0;l<e.sum.length;l++)s[n][e.sum[l]]+=Number(r[a][t[e.sum[l]]])}else{s[n]={Total:0};for(var l=0;l<e.keep.length;l++)s[n][e.keep[l]]=r[a][t[e.keep[l]]];for(var l=0;l<e.sum.length;l++)s[n][e.sum[l]]=Number(r[a][t[e.sum[l]]])}s[n].Total+=h,s[n][u]?(e.calc,"max"==e.calc?s[n][u]=Math.max(h,s[n][u]):(s[n][u]+=h,s[n][u+"count"]++)):(s[n][u]=h,s[n][u+"count"]=1)}this.__pivot=new Data.Table;for(this.__pivot.records,l=0;l<e.lead.length;l++)this.__pivot.fields.push({id:e.lead[l]});for(l=0;l<e.keep.length;l++)this.__pivot.fields.push({id:e.keep[l]});for(l=0;l<e.sum.length;l++)this.__pivot.fields.push({id:e.sum[l]});for(var c in o)this.__pivot.fields.push({id:c});this.__pivot.fields.push({id:"Total"});for(var c in s){var p=new Array,d=c.split("|");for(l=0;l<d.length;l++)p.push(d[l]);for(l=0;l<e.keep.length;l++)p.push(s[c][e.keep[l]]);for(l=0;l<e.sum.length;l++)p.push(s[c][e.sum[l]]);for(var f in o)"mean"==e.calc?p.push((s[c][f]||0)/(s[c][f+"count"]||1)):p.push(s[c][f]||0);p.push(s[c].Total),this.__pivot.records.push(p),this.__pivot.table.records++}return this.__pivot},subtable:function(e){if(this.__subt=new Data.Table,e.fields){e.columns=[];for(var t=0;t<e.fields.length;t++)for(var i=0;i<this.fields.length;i++)this.fields[i].id==e.fields[t]&&e.columns.push(i)}for(t=0;t<e.columns.length;t++)this.__subt.fields.push({id:String(this.fields[e.columns[t]].id)}),this.__subt.table.fields++;for(var s in this.records){var o=[];for(t=0;t<e.columns.length;t++)o.push(this.records[s][e.columns[t]]);this.__subt.records.push(o),this.__subt.table.records++}return this.__subt},sort:function(e){for(var t=this.column(e).values(),i=[],s=0;s<t.length;s++)i.push({index:s,value:t[s]});i.sort(function(e,t){return e.value<t.value?-1:1});var o=[];for(s=0;s<i.length;s++)o.push(this.records[i[s].index]);return this.records=o,this},append:function(e){if(this.table.fields.length!=e.table.fields.length)return null;for(var t=0;t<this.table.fields.length;t++)if(this.table.fields[t].id!=e.table.fields[t].id)return null;var i=e.records;for(t=0;t<i.length;t++)this.records.push(i[t]);return this.table.records=this.records.length,this},json:function(){this.__json=[];for(var e in this.records){var t={};for(var i in this.fields)t[String(this.fields[i].id)]=this.records[e][i];this.__json.push(t)}return this.__json}},__myNumber=function(e){var t=parseFloat(e.replace(/\./g,"").replace(/\,/g,"."));return isNaN(t)?0:t},__scanValue=function(e){if(String(e).match(/,/)){var t=parseFloat(String(e).replace(/\./gi,"").replace(/,/gi,"."));return isNaN(t)?0:t}t=parseFloat(String(e).replace(/ /gi,""));return isNaN(t)?0:t},Data.Table.prototype.addTimeColumns=function(e){if(!e.source)return null;for(var t in this.fields)if(this.fields[t].id==e.source){for(var i=e.create||["date","year","month","day","hour"],s=0;s<i.length;s++)this.fields.push({id:String(i[s])}),this.table.fields++;var o=this.records.length,r=0;for(r=0;r<o;r++){var a=new Date(this.records[r][t]);if(a)for(s=0;s<i.length;s++)switch(i[s]){case"date":var n=String(a.getDate())+"."+String(a.getMonth()+1)+"."+String(a.getFullYear());this.records[r].push(n);break;case"year":this.records[r].push(a.getFullYear());break;case"month":this.records[r].push(a.getMonth()+1);break;case"day":this.records[r].push(a.getDay());break;case"hour":this.records[r].push(a.getHours())}}}return this},Data.Column=function(){this.table=null,this.index=null,this.valueA=null},Data.Column.prototype={values:function(){this.valueA=[];for(var e in this.table.records)this.valueA.push(this.table.records[e][this.index]);return this.valueA},uniqueValues:function(){this.valueA=[];for(var e in this.table.records)this.valueA.push(this.table.records[e][this.index]);return this.valueA.filter(__onlyUnique)},map:function(e){for(var t in this.table.records)this.table.records[t][this.index]=e(this.table.records[t][this.index],this.table.records[t],this.index);return this},rename:function(e){return this.table.fields[this.index].id=e,this},remove:function(){this.table.fields.splice(this.index,1);for(var e in this.table.records)this.table.records[e].splice(this.index,1);return this.table.table.fields--,this}},Data.Feed.prototype.column=function(e){return this.dbtable.column(e)},Data.Feed.prototype.select=function(e){return this.dbtable.select(e)},Data.Feed.prototype.aggregate=function(e,t){return this.dbtable.aggregate(e,t)},Data.Feed.prototype.revert=function(){return this.dbtable.revert()},Data.Feed.prototype.reverse=function(){return this.dbtable.reverse()},Data.Feed.prototype.pivot=function(e){return this.dbtable.pivot(e)},Data.Feed.prototype.subtable=function(e){return this.dbtable.subtable(e)},Data.Feed.prototype.addTimeColumns=function(e){return this.dbtable.addTimeColumns(e)},Data.Broker=function(e){this.souceQueryA=[],this.options=e,e&&this.parseDefinition(e),this.onNotify=function(){},this.onError=function(){}},Data.Broker.prototype=new Data.Feed,Data.Broker.prototype={addSource:function(e,t){return _LOG("Data.Broker.addSource: "+e),this.souceQueryA.push({url:e,type:t,data:null,result:null,next:this}),this},setCallback:function(e){return this.callback=e,this},realize:function(e){this.callback=e||this.callback;for(var t in this.souceQueryA)if(this.souceQueryA[t].url&&!this.souceQueryA[t].result)return this.getData(this.souceQueryA[t]),this;this.data=[];for(var t in this.souceQueryA)this.data.push(this.souceQueryA[t].data);return this.callback(this.data),this},error:function(e){return this.onError=e||this.onError,this},notify:function(e){return this.onNotify=e||this.onNotify,this}},Data.Broker.prototype.parseDefinition=function(e){this.callback=e.callback||null},Data.Broker.prototype.getData=function(e){this.onNotify(e),e.feed=Data.feed({source:e.url,type:e.type,options:e.next.options,parent:this}).load(function(t){e.data=t,this.parent.onNotify(e),e.result="success",e.next.realize(),e.data.raw=e.feed.data}).error(function(t){e.data=null,e.result="error",e.next.realize()})},Data.Broker.prototype.setData=function(e){this.parent.__doCreateTableDataObject(e,null,this.parent.options)},Data.Feed.prototype.broker=function(e){var t=new Data.Broker(e);return t.parent=this,t},Data.broker=function(){return new Data.Broker},Data.Merger=function(e){this.sourceA=[],this.options=e,e&&this.parseDefinition(e)},Data.Merger.prototype={addSource:function(e,t){return this.sourceA.push({data:e,opt:t}),this},setOutputColumns:function(e){return this.outColumnsA=e,this},realize:function(e){this.callback=e||this.callback,_LOG("DataMerger: >>>");var t=[];for(i in this.sourceA){var s=this.sourceA[i];s.opt.columns=s.opt.columns||s.data.columnNames||s.data.columnNames(),s.opt.label=s.opt.label||[],s.opt.columns=__toArray(s.opt.columns),s.opt.label=__toArray(s.opt.label),this.sourceA[i].data||_alert("DataMerger: source '"+i+"' not found"),this.sourceA[i].data[0]||(this.sourceA[i].data=this.sourceA[i].data.getArray()),this.sourceA[i].data[0]||_alert("DataMerger: source '"+i+"' not found or not of type Array");var o=[];for(ii in this.sourceA[i].data[0]){this.sourceA[i].data[0][ii]==this.sourceA[i].opt.lookup&&(o[this.sourceA[i].opt.lookup]=ii);for(iii in this.sourceA[i].opt.columns)this.sourceA[i].opt.label[iii]||(this.sourceA[i].opt.label[iii]=this.sourceA[i].opt.columns[iii]+"."+(Number(i)+1)),this.sourceA[i].data[0][ii]==this.sourceA[i].opt.columns[iii]&&(o[this.sourceA[i].opt.label[iii]]=ii)}for(iii in this.sourceA[i].opt.columns)o[this.sourceA[i].opt.label[iii]]||_LOG("DataMerger: '"+this.sourceA[i].opt.label[iii]+"' not found");t.push(o)}var r=[];for(i in this.sourceA)for(ii in this.sourceA[i].opt.label)r.push(this.sourceA[i].opt.label[ii]);if(!this.outColumnsA){this.outColumnsA=[];for(i in r)this.outColumnsA.push(r[i])}var a=[];for(i in this.outColumnsA)for(ii in t)for(iii in t[ii])iii==this.outColumnsA[i]&&(a[iii]={input:ii,index:t[ii][iii]});for(i in this.outColumnsA)if(!a[this.outColumnsA[i]])for(ii in this.sourceA[0].data[0])this.sourceA[0].data[0][ii]==this.outColumnsA[i]&&(a[this.outColumnsA[i]]={input:0,index:ii});for(this.namedSourceA=[],i=1;i<this.sourceA.length;i++)for(this.namedSourceA[i]=[],ii=1;ii<this.sourceA[i].data.length;ii++)this.namedSourceA[i][String(this.sourceA[i].data[ii][t[i][this.sourceA[i].opt.lookup]])]=this.sourceA[i].data[ii];var n=[];for(n.push(this.outColumnsA),i=1;i<this.sourceA[0].data.length;i++){var l=String(this.sourceA[0].data[i][[t[0][this.sourceA[0].opt.lookup]]]),u=[];for(ii in this.outColumnsA){var h=a[this.outColumnsA[ii]];if(!h)return _alert('DataMerger - missing "'+this.outColumnsA[ii]+'" in label:[...]'),null;0==h.input?u.push(this.sourceA[0].data[i][h.index]):this.namedSourceA[h.input][l]?u.push(this.namedSourceA[h.input][l][h.index]):u.push(" ")}n.push(u)}_LOG("DataMerger: done");var c=new Data.Table;return c.setArray(n),this.callback&&this.callback(c),c},error:function(e){return this.onError=e||this.onError,this}},Data.merger=function(){return new Data.Merger},console.log("*** data.js "+Data.version+" ***");var _alert=function(e){console.log("data.js v"+Data.version+": "+e)}}(window,document);